<!--
  app/views/partials/pin-lock-screen.html

  The PIN lock screen for user authentication.
  It provides a secure way for users to enter their PIN without relying on the
  standard browser keyboard. It manages its own state and dispatches an 'unlock'
  event when a 4-digit PIN is entered.
-->
<div 
    class="pin-lock-screen" 
    x-data="pinLockScreen()"
    x-init="init()"
    x-show="isLocked"
    @unlock-failed.window="showError()"
    x-transition
>
    <div class="pin-lock-content">
        <h3>أدخل رمز الدخول</h3>
        
        <!-- Visual feedback for PIN entry -->
        <div class="pin-dots" :class="{ 'shake': error }">
            <template x-for="i in 4" :key="i">
                <span class="dot" :class="{ 'filled': pin.length >= i }"></span>
            </template>
        </div>

        <p x-show="error" class="error-message" aria-live="assertive">رمز الدخول غير صحيح. حاول مرة أخرى.</p>

        <!-- Custom numeric keypad -->
        <div class="keypad">
            <template x-for="num in [1, 2, 3, 4, 5, 6, 7, 8, 9]">
                <button @click="append(num)" x-text="num" :aria-label="'رقم ' + num"></button>
            </template>
            
            <!-- The last row of the keypad -->
            <button class="keypad-icon" @click="clear()" aria-label="مسح الكل">مسح</button>
            <button @click="append(0)" aria-label="رقم 0">0</button>
            <button class="keypad-icon" @click="backspace()" aria-label="مسح للخلف">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"></path><line x1="18" y1="9" x2="12" y2="15"></line><line x1="12" y1="9" x2="18" y2="15"></line></svg>
            </button>
        </div>
    </div>
</div>

<script>
function pinLockScreen() {
    return {
        pin: '',
        error: false,

        init() {
            // Listen for physical keyboard events for accessibility and convenience
            window.addEventListener('keydown', (e) => {
                if (this.$root.isLocked) {
                    if (!isNaN(parseInt(e.key))) {
                        this.append(e.key);
                    } else if (e.key === 'Backspace') {
                        this.backspace();
                    }
                }
            });
        },

        /**
         * Appends a number to the PIN. If the PIN reaches 4 digits,
         * it dispatches the 'unlock' event for verification.
         * @param {string|number} num - The number to append.
         */
        append(num) {
            if (this.pin.length >= 4) return;
            
            this.pin += num;
            this.error = false;

            if (this.pin.length === 4) {
                this.$dispatch('unlock', { pin: this.pin });
            }
        },

        /**
         * Removes the last digit from the PIN.
         */
        backspace() {
            this.pin = this.pin.slice(0, -1);
            this.error = false;
        },

        /**
         * Clears the entire PIN input.
         */
        clear() {
            this.pin = '';
            this.error = false;
        },

        /**
         * Shows an error state and clears the PIN after a short delay.
         * This is triggered by the 'unlock-failed' event from the AuthController.
         */
        showError() {
            this.error = true;
            setTimeout(() => {
                this.pin = '';
                this.error = false;
            }, 800); // Duration should match the CSS shake animation
        }
    };
}
</script>

